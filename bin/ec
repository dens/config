#!/bin/bash

# Usage:
#   $ ec [EMACSCLIENT-OPTIONS] FILE...
#      open file in new frame
#
#   $ ec -t FILE...
#      open file in terminal
#
#   $ ec -ex FILE...
#      open file in existing frame and detach (--no-wait)
#
#   $ ec -bg FILE...
#      open file in new frame and fork
#
#   $ ec -srv
#      start server
#
# Environment Variables:
#   EMACS_SERVER_NAME
#   EMACS_SERVER_ARGS
#

export EMACS_SERVER_NAME=${EMACS_SERVER_NAME:-"server"}
export EMACS_SERVER_PIDFILE=$HOME/.emacs-${EMACS_SERVER_NAME}.pid

server()
{
    if ! emacsclient -s $EMACS_SERVER_NAME --eval t >/dev/null 2>&1; then
        DISPLAY= emacs \
            $EMACS_SERVER_ARGS \
            --eval "(setq server-name \"$EMACS_SERVER_NAME\")" \
            --daemon "$@" >/dev/null 2>&1
    fi
}

if [ "$1" = "-srv" ]; then
    server &
    exit
else
    server
fi

existing=""
if [ "$1" = "-ex" ]; then
    shift
    existing=t
fi

background=""
if [ "$1" = "-bg" ]; then
    shift
    background=t
fi

if [ -z "$DISPLAY" ]; then
    # new frame in terminal
    exec emacsclient -s $EMACS_SERVER_NAME -t -c "$@"
elif [ "$existing" ]; then
    # existing frame in background
    exec emacsclient -s $EMACS_SERVER_NAME -n "$@"
elif [ "$background" ]; then
    # new frame in background
    exec emacsclient -s $EMACS_SERVER_NAME -c "$@" >/dev/null &
else
    # default: new frame
    exec emacsclient -s $EMACS_SERVER_NAME -c "$@"
fi
