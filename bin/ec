#!/bin/bash

# Usage:
#   $ ec [EMACSCLIENT-OPTIONS] FILE...
#
# Environment Variables:
#   EMACS_SERVER_NAME
#   EMACS_SERVER_ARGS
#

export EMACS_SERVER_NAME=${EMACS_SERVER_NAME:-"server"}

start_server()
{
    if ! emacsclient -s $EMACS_SERVER_NAME --eval t >/dev/null 2>&1; then
        DISPLAY= emacs \
            $EMACS_SERVER_ARGS \
            --eval "(setq server-name \"$EMACS_SERVER_NAME\")" \
            --daemon "$@" >/dev/null 2>&1
    fi
}

if [ "$1" = "-srv" ]; then
    start_server &
    exit
else
    start_server
fi

args=()
for i in "$@"; do
    if [ "$i" = "-bg" ]; then
        background=t
    else
        args=("${args[@]}" "$i")
    fi
done

if [ -z "$DISPLAY" ]; then
    exec emacsclient -s $EMACS_SERVER_NAME -c -t "${args[@]}"
else
    if [ "$background" ]; then
        exec emacsclient -s $EMACS_SERVER_NAME -c "${args[@]}" >/dev/null &
    else
        exec emacsclient -s $EMACS_SERVER_NAME -c "${args[@]}"
    fi
fi


# existing=""
# if [ "$1" = "-ex" ]; then
#     shift
#     existing=t
# fi
# 
# background=""
# if [ "$1" = "-bg" ]; then
#     shift
#     background=t
# fi

# elif [ "$existing" ]; then
#     # existing frame in background
#     exec emacsclient -s $EMACS_SERVER_NAME -n "$@"
# elif [ "$background" ]; then
#     # new frame in background
#     exec emacsclient -s $EMACS_SERVER_NAME -c "$@" >/dev/null &
# else
#     # default: new frame
#     exec emacsclient -s $EMACS_SERVER_NAME -c "$@"
# fi
