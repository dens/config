#!/bin/bash

export EMACS_SERVER_NAME=${EMACS_SERVER_NAME:-"server"}
export EMACS_SERVER_PIDFILE=$HOME/.emacs-${EMACS_SERVER_NAME}.pid

if [ ! -f "$EMACS_SERVER_PIDFILE" ]; then
    startscript=$(mktemp)
    (
        cat <<EOF > $startscript
(let ((server-name "$EMACS_SERVER_NAME"))
  (server-start)
  (with-temp-buffer
    (insert (format "%i\n" (emacs-pid)))
    (write-region (point-min) (point-max) "$EMACS_SERVER_PIDFILE")))
EOF
        pushd ~ >/dev/null
        screen -D -m emacs $EMACS_SERVER_ARGS -l $startscript -nw &
        popd >/dev/null
        pid=$!
        wait $pid
        rm $EMACS_SERVER_PIDFILE
    ) &

    while [ ! -f "$EMACS_SERVER_PIDFILE" ]; do
        sleep 1
    done

    rm $startscript
fi

background=""
if [ "$1" = "-bg" ]; then
    shift
    background=t
fi

existing=""
if [ "$1" = "-ex" ]; then
    shift
    existing=t
fi

if [ -z "$DISPLAY" ]; then
    # new frame in terminal
    exec emacsclient -s $EMACS_SERVER_NAME -t -c "$@"
elif [ "$existing" ]; then
    # existing frame in background
    exec emacsclient -s $EMACS_SERVER_NAME -n "$@"
elif [ "$background" ]; then
    # new frame in background
    exec emacsclient -s $EMACS_SERVER_NAME -c "$@" >/dev/null &
else
    # default: new frame
    exec emacsclient -s $EMACS_SERVER_NAME -c "$@"
fi
